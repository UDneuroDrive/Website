<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
        content="neuroDrive is a team of students working towards creating a small scale autonomous vehicle that learns to navigate with intention.">
    <meta name="keywords"
        content="Machine Learning, Computer Vision, Raspberry Pi, Autonomus Vehicle, Autonomous RC Vehicle, RC Vehicle">

    <title>Entry | neuroDrive Senior Design Team</title>

    <!-- Styles -->
    <link href="../assets/css/page.min.css" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet">

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
    <link rel="manifest" href="/assets/img/favicons/site.webmanifest">
    <link rel="mask-icon" href="/assets/img/favicons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <!--  Open Graph Tags -->
    <meta property="og:title" content="Entry | neuroDrive Senior Design Team">
    <meta property="og:description"
        content="neuroDrive is a team of students working towards creating a small scale autonomous vehicle that learns to navigate with intention.">

    <style>
        .background-tint {
            background-color: rgba(0, 0, 0, .5);
            background-blend-mode: multiply;
        }

        .header {
            margin-bottom: 0px !important;
        }

        #currentImage {
            height: 300px;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">

            <div class="navbar-left">
                <button class="navbar-toggler" type="button"><span class="navbar-toggler-icon"></span></button>
                <a class="navbar-brand" href="/">
                    <span class="text-white">neuro<strong>Drive</strong></span>

                </a>
            </div>

            <section class="navbar-mobile">
                <nav class="nav nav-navbar ml-auto">

                    <a class="nav-link" href="manage.html">Manage Entries</a>

                    <a class="nav-link" href="entry.html">Add Entry</a>

                </nav>

                <span class="navbar-divider"></span>

                <div>
                    <a class="btn btn-sm btn-round btn-danger ml-lg-4 mr-2 text-white" onclick="logout()">Log out</a>
                </div>
            </section>

        </div>
    </nav><!-- /.navbar -->

    <!-- Header -->
    <header class="header pb-9 pt-10 mb-9 background-tint"
        style="background-image: url(../assets/img/raspberrypi4.jpg)">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h1 class="fw-200 mb-6 text-white">Add Entry</h1>
                </div>
            </div>
        </div>
    </header><!-- /.header -->


    <!-- Main Content -->
    <main class="main-content">
        <section class="section bg-gray p-0">
            <div class="container">
                <div class="row">
                    <div style="margin-bottom: 60px" id="content" class="col-md-10 col-xl-9 mx-auto">

                        <form style="margin-bottom: 60px" onsubmit="return entryController(event)">

                            <div id="image" style="margin-top: 40px; margin-bottom: 20px;">

                            </div>

                            <div style="margin-top: 20px; margin-bottom: 20px;" class="row">
                                <div class="form-group col-12 col-md-12">
                                    <input style="display: none" type="file" id="uploadImage" class="file-select"
                                        onchange="handleFileUploadChange(event)" accept="image/*" />
                                    <button onclick="document.getElementById('uploadImage').click();" type="button"
                                        class="btn btn-label btn-primary">
                                        <label><i class="fa fa-upload"></i></label> Upload
                                    </button>
                                </div>
                            </div>


                            <div class="row">
                                <div class="form-group col-12 col-md-12">
                                    <input id="title" class="form-control" type="text" placeholder="Title">
                                </div>
                            </div>

                            <div class="form-group">
                                <textarea id="body" class="form-control" placeholder="Body" rows="4"></textarea>
                            </div>

                            <button class="btn btn-primary btn-block" id="submit" type="submit">Post your entry</button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center">

            <p class="small">Copyright Â© <span id="year"></span> neuroDrive, All rights reserved.</p>

        </div>
    </footer><!-- /.footer -->
    <script>
        var dt = new Date();
        document.getElementById("year").innerHTML = dt.getYear() + 1900;
    </script>


    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-storage.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-analytics.js"></script>

    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyBortf5pyvTENtdsF4faBCf_3PQWPG_VCY",
            authDomain: "neurodrive-senior.firebaseapp.com",
            databaseURL: "https://neurodrive-senior.firebaseio.com",
            projectId: "neurodrive-senior",
            storageBucket: "neurodrive-senior.appspot.com",
            messagingSenderId: "627396498743",
            appId: "1:627396498743:web:cd7d1f037f8367ad1eb6b2",
            measurementId: "G-Q4PMGNR560"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();

        const storage = firebase.storage();
        const storageRef = storage.ref();

        var db = firebase.firestore();

        var urlParams = new URLSearchParams(window.location.search);

        if (urlParams.has("id")) { // This is in an edit mode
            var id = urlParams.get('id')

            // populate user data
            db.collection("posts").doc(id).get().then(function (doc) {
                document.getElementById("title").value = doc.data()["title"]
                document.getElementById("body").innerText = doc.data()["body"]
                if (doc.data()["image"] != null) {
                    document.getElementById("image").innerHTML = `<img id="currentImage" src="${doc.data()["image"]}" alt="Current Image">`
                }
            }).catch(function (error) {
                console.log("Error getting document:", error);
            });

        }

        var allUsers = { "vUvrs5pHvvTpB5JHligXJ4nO1uT2": "anthonysette", "tRcERq8PxSTEdwzOhV1cq1mNHao1": "justusmatteson", "XA778erOC5Tz8zTGuVKL3eP4NSt1": "kunalvohra", "clIwi6AJZSOQsx4yFbuJJtQEEc12": "walterhoffman" }
        var user;

        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                var uid = user.uid;

            } else {
                // user is not logged in
                window.location.replace("/admin.html");
            }
        });

        let selectedFile;

        function handleFileUploadChange(e) {
            selectedFile = e.target.files[0];

            var oFReader = new FileReader();
            oFReader.readAsDataURL(document.getElementById("uploadImage").files[0]);

            oFReader.onload = function (oFREvent) {
                document.getElementById("image").innerHTML = `<img id="currentImage" src="${oFREvent.target.result}" alt="Current Image">`
            };
        }


        function getRandomString() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)
        }

        function entryController(e) {
            if(urlParams.has("id")){
                editEntry(e);
            } else {
                addEntry(e);
            }
            return false
        }

        function editEntry(e){
            document.getElementById('submit').disabled = true;
            var id = urlParams.get('id')
            var user = firebase.auth().currentUser;
            if (user) {
                var uid = user.uid;
                var username = allUsers[uid]

                var title = document.getElementById("title").value;
                var body = document.getElementById("body").value;

                if (title == "" || body == "") {
                    alert("There must be a title and a body for your entry.")
                    document.getElementById('submit').disabled = false;
                    return false;
                }

                if (selectedFile != null) {
                    const uploadTask = storageRef.child(`images/${getRandomString()}`).put(selectedFile); //create a child directory called images, and place the file inside this directory
                    uploadTask.on('state_changed', (snapshot) => {
                        // Observe state change events such as progress, pause, and resume
                    }, (error) => {
                        // Handle unsuccessful uploads
                        document.getElementById('submit').disabled = false;
                        alert("Error adding new files: ", error);
                    }, () => {
                        // Do something once upload is complete

                        uploadTask.snapshot.ref.getDownloadURL().then(function (downloadURL) {
                            console.log('File available at', downloadURL);

                            // The file was successfully updated so we can now post data
                            // Add a new document with a generated id.
                            db.collection("posts").doc(id).update({
                                title: title,
                                body: body,
                                image: downloadURL,
                                video: null,

                            })
                            .then(function() {
                                window.location.replace("manage.html");
                                console.log("Document saved with ID: ", id);
                            })
                            .catch(function(error) {
                                alert("Error saving document: ", error);
                            });

                        });
                        console.log('success');
                    });
                } else { //update doc not file
                    // Update doc
                    db.collection("posts").doc(id).update({
                        title: title,
                        body: body,

                    })
                    .then(function() {
                        console.log("Document saved with ID: ", id);
                        window.location.replace("manage.html");
                    })
                    .catch(function(error) {
                        console.error(error)
                        alert("Error saving document: ", error);
                    });
                }
            } else {
                window.location.replace("/admin.html");
            }
            return false;
        }

        function addEntry(e) {
            document.getElementById('submit').disabled = true;
            var user = firebase.auth().currentUser;
            if (user) {
                var uid = user.uid;
                var username = allUsers[uid]

                var title = document.getElementById("title").value;
                var body = document.getElementById("body").value;

                if (title == "" || body == "") {
                    alert("There must be a title and a body for your entry.")
                    document.getElementById('submit').disabled = false;
                    return false;
                }

                if (selectedFile != null) {
                    const uploadTask = storageRef.child(`images/${getRandomString()}`).put(selectedFile); //create a child directory called images, and place the file inside this directory
                    uploadTask.on('state_changed', (snapshot) => {
                        // Observe state change events such as progress, pause, and resume
                    }, (error) => {
                        // Handle unsuccessful uploads
                        document.getElementById('submit').disabled = false;
                        alert("Error adding files: ", error);
                    }, () => {
                        // Do something once upload is complete

                        uploadTask.snapshot.ref.getDownloadURL().then(function (downloadURL) {
                            console.log('File available at', downloadURL);

                            // The file was successfully updated so we can now post data
                            // Add a new document with a generated id.
                            db.collection("posts").add({
                                title: title,
                                body: body,
                                image: downloadURL,
                                video: null,
                                user: username,
                                date: firebase.firestore.FieldValue.serverTimestamp()

                            })
                                .then(function (docRef) {
                                    window.location.replace("manage.html");
                                    console.log("Document written with ID: ", docRef.id);
                                })
                                .catch(function (error) {
                                    alert("Error adding document: ", error);
                                });

                        });
                        console.log('success');
                    });
                } else { //add document without file
                    // Add a new document with a generated id.
                    db.collection("posts").add({
                        title: title,
                        body: body,
                        image: null,
                        video: null,
                        user: username,
                        date: firebase.firestore.FieldValue.serverTimestamp()

                    })
                        .then(function (docRef) {
                            window.location.replace("manage.html");
                            console.log("Document written with ID: ", docRef.id);
                        })
                        .catch(function (error) {
                            document.getElementById('submit').disabled = false;
                            alert("Error adding document: ", error);
                        });
                }
            } else {
                window.location.replace("/admin.html");
            }
            return false;
        }

        function logout() {
            firebase.auth().signOut().then(function () {
                window.location.replace("/admin.html");
            }).catch(function (error) {
                console.log("An error occured")
            });
        }


    </script>

</body>

</html>